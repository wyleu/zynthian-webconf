
<h2>{{ escape(title) }}</h2>

<form method="post">
<div class="container-fluid lib-treeview">
	<div class="row">

		<div class="col-md-5">
			<div id="snapshot-tree"></div>
			<div class="input-group">
				<span class="input-group-addon">
					<label>New bank</label>
				</span>
				<input  name="ZYNTHIAN_SNAPSHOT_NEXT_BANK_NUMBER" value="{{ config['ZYNTHIAN_SNAPSHOT_NEXT_BANK_NUMBER'] }}" class="form-control">
				<span class="input-group-btn">
					<button class="btn btn-default btn-block" name="ZYNTHIAN_SNAPSHOT_ACTION" value="NEW_BANK">
					<span class="glyphicon glyphicon-plus" aria-hidden="true"></span></button>
				</span>
			</div>
		</div>

		<div id="snapshot-panel" class="col-md-7">
			<div class="row">
				<label>Name:</label>
			</div>
			<div class="row">
				<input id="ZYNTHIAN_SNAPSHOT_NAME" name="ZYNTHIAN_SNAPSHOT_NAME" class="form-control" />
				<input type="hidden" id="ZYNTHIAN_SNAPSHOT_FULLPATH" name="ZYNTHIAN_SNAPSHOT_FULLPATH" />
			</div>
			<div class="row">
				<label>Bank/Program:</label>
			</div>
			<div class="row">
				<div class="col-md-6">
					<input type="hidden" id="ZYNTHIAN_SNAPSHOT_SELECTION_BANK_NO" name="ZYNTHIAN_SNAPSHOT_SELECTION_BANK_NO" />
					<select id="ZYNTHIAN_SNAPSHOT_SELECTION_BANK" name="ZYNTHIAN_SNAPSHOT_SELECTION_BANK"
						class="form-control">
						{% for option in config['ZYNTHIAN_SNAPSHOT_BANKS'] %}
							<option value="{{  option  }}" >{{ option }}</option>
						{% end %}
					</select>
				</div>
				<div class="col-md-6">
					<select id="ZYNTHIAN_SNAPSHOT_SELECTION_PROGRAM" name="ZYNTHIAN_SNAPSHOT_SELECTION_PROGRAM"
						class="form-control">
						{% for option in config['ZYNTHIAN_SNAPSHOT_PROGRAMS'] %}
							<option value="{{  option  }}" >{{ option }}</option>
						{% end %}
					</select>
				</div>
			</div>
			<div class="row">
				<button name="ZYNTHIAN_SNAPSHOT_ACTION" value="REMOVE" onclick="return confirm('Are you sure?');" class="btn btn-danger btn-block">DELETE</button>
			</div>
			<div class="row">
				<p>
					<textarea id="ZYNTHIAN_SNAPSHOT_SELECTION_DETAILS" name="ZYNTHIAN_SNAPSHOT_SELECTION_DETAILS" rows="10">
					</textarea>
				</p>
			</div>
		</div>

	</div>

	<div class="row">
	{% if errors %}<div class="alert alert-danger">{{ escape(errors) }}</div>{% end %}
	</div>

	<div class="row">
		<button name="ZYNTHIAN_SNAPSHOT_ACTION" value="SAVE" class="btn btn-lg btn-theme btn-block">Save</button>
	</div>

</div>
</form>

<script type="text/javascript">

$('#snapshot-panel').hide();
$('#zynthian-selection-customized-panel').hide();
$('#snapshot-tree').treeview({data: JSON.parse('{% raw config['ZYNTHIAN_SNAPSHOTS'].replace("'", "&#39;") %}'), bootstrap2: true ,
	emptyIcon: "glyphicon glyphicon-floppy-disk",
	expandIcon: "glyphicon glyphicon-folder-close",
	collapseIcon: "glyphicon glyphicon-folder-open",
	onNodeSelected: function(event, data) {
		$("#ZYNTHIAN_SNAPSHOT_NAME")[0].value = data.name.replace("&#39;","'");
		$("#ZYNTHIAN_SNAPSHOT_FULLPATH")[0].value = data.fullpath;
		$("#ZYNTHIAN_SNAPSHOT_SELECTION_BANK_NO")[0].value = data.bank;
		$("#ZYNTHIAN_SNAPSHOT_SELECTION_BANK")[0].value = data.bank + (data.bankName? '-' + data.bankName.replace("&#39;","'") : '');
		$("#ZYNTHIAN_SNAPSHOT_SELECTION_BANK")[0].disabled = data.nodes;
		$("#ZYNTHIAN_SNAPSHOT_SELECTION_PROGRAM")[0].value = data.program;
		$("#ZYNTHIAN_SNAPSHOT_SELECTION_PROGRAM")[0].disabled = data.nodes;
		$("#ZYNTHIAN_SNAPSHOT_SELECTION_DETAILS")[0].disabled = false;
		if (data.details){
			$("#ZYNTHIAN_SNAPSHOT_SELECTION_DETAILS").show();
			$("#ZYNTHIAN_SNAPSHOT_SELECTION_DETAILS")[0].value = formatSnapshotDetails(data.details);
		} else {
			$("#ZYNTHIAN_SNAPSHOT_SELECTION_DETAILS").hide();
		}
		$('#snapshot-panel').show();
	}
});
$('#snapshot-tree').treeview('selectNode',{% raw config['ZYNTHIAN_SNAPSHOT_SELECTION_NODE_ID'] %});

function formatSnapshotDetails(snapshotDetails){
	var result = '';
	for (idx in snapshotDetails.layers){
		layer = snapshotDetails.layers[idx]
		result += layer.engine_nick + (layer.midi_chan + 1) + "-" + layer.bank_name + "/" + layer.preset_name + "\n";
	}
	return result;
}

</script>
